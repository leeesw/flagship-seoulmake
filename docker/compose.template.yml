version: "3.9"\n\nx-common-env: &common_env\n  RAILS_ENV: production\n  RACK_ENV: production\n  REDIS_URL: ${REDIS_URL}\n  DATABASE_URL: ${DATABASE_URL}\n  WP_BASE_URL: ${WP_BASE_URL}\n  ACTIVE_COLOR_KEY: sm:active_color\n  COLOR: ${COLOR}\n  OPS_TARGET_VERSION: ${OPS_TARGET_VERSION}\n\nx-sidekiq-common: &sidekiq_common\n  image: ${APP_IMAGE}\n  restart: always\n  depends_on:\n    - app\n  environment:\n    <<: *common_env\n  deploy:\n    resources:\n      limits:\n        cpus: "${LIMIT_CPUS}"\n        memory: ${LIMIT_MEM}\n\nservices:\n  app:\n    image: ${APP_IMAGE}\n    restart: always\n    environment:\n      <<: *common_env\n    command: bundle exec puma -C config/puma.rb\n    labels:\n      - "traefik.enable=true"\n      - "traefik.http.routers.${COLOR}.rule=Host(`${COLOR}.seoulmake.com`)"\n      - "traefik.http.routers.${COLOR}.entrypoints=websecure"\n      - "traefik.http.routers.${COLOR}.tls=true"\n    expose:\n      - "3000"\n\n  sidekiq-io:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: io,io_default\n      LIMIT_CPUS: "1.0"\n      LIMIT_MEM: 1536M\n      CONCURRENCY: "20"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q io -q io_default"\n\n  sidekiq-llm:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: llm\n      LIMIT_CPUS: "0.5"\n      LIMIT_MEM: 1024M\n      CONCURRENCY: "3"\n      LLM_RATE_PER_MIN: "30"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q llm"\n\n  sidekiq-analytics:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: analytics\n      LIMIT_CPUS: "0.6"\n      LIMIT_MEM: 1024M\n      CONCURRENCY: "3"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q analytics"\n\n  sidekiq-cpu:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: cpu\n      LIMIT_CPUS: "2.0"\n      LIMIT_MEM: 2560M\n      CONCURRENCY: "2"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q cpu"\n\n  sidekiq-indexing:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: indexing\n      LIMIT_CPUS: "0.2"\n      LIMIT_MEM: 512M\n      CONCURRENCY: "2"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q indexing"\n\n  sidekiq-admatch:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: admatch\n      LIMIT_CPUS: "0.3"\n      LIMIT_MEM: 768M\n      CONCURRENCY: "4"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q admatch"\n\n  sidekiq-scheduler:\n    <<: *sidekiq_common\n    environment:\n      <<: *common_env\n      QUEUES: scheduler\n      LIMIT_CPUS: "0.1"\n      LIMIT_MEM: 256M\n      CONCURRENCY: "1"\n    command: bash -lc "bundle exec sidekiq -r ./config/environment -c ${CONCURRENCY} -q scheduler -C config/sidekiq-cron.yml"\n\n