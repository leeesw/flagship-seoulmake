module Analytics\n  class WordCountWorker\n    include Sidekiq::Worker\n    sidekiq_options queue: :analytics\n    def perform(post_id)\n      p = Post.find(post_id)\n      text = strip_for_count(p.content_html)\n      words = text.split(/\s+/).reject(&:blank?).size\n      reading_sec = (words / 200.0 * 60).round\n      PostsMetric.upsert!(post_id: p.id, words: words, reading_time_sec: reading_sec)\n      PostsOpsStep.upsert_step(post_id: p.id, step: 'word_count', version: '1.0.0')\n    end\n    def strip_for_count(html)\n      doc = Nokogiri::HTML::fragment(html)\n      doc.css('script,style,iframe,[data-atr-preserve="1"]').remove\n      doc.text\n    end\n  end\nend\n\n